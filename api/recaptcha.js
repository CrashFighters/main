const https=require("https"),secret=require("../credentials/recaptcha.json").private,{hostname:hostname,port:port,path:path,full:full}=require("../credentials/recaptcha.json").endpoint,headers={"Content-Type":"application/x-www-form-urlencoded","Content-Length":null},allowedTokenCharacters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split("");module.exports={async execute({params:e,end:r,statusCode:t,request:n,parseError:o}){try{if(!e.token)return t(400,"No token provided");if(526!==e.token.length)return t(400,"Invalid token");if(e.token.split("").some((e=>!allowedTokenCharacters.includes(e))))return t(400,"Invalid token");const o=Object.entries({secret:secret,response:e.token,remoteip:n.socket.remoteAddress}).map((([e,r])=>`${e}=${r}`)).join("&");headers["Content-Length"]=o.length;const s=await fetch(full,{method:"POST",body:o,headers:headers}),i=await s.json();if(!i.success){if(i["error-codes"].includes("missing-input-secret")||i["error-codes"].includes("invalid-input-secret")||i["error-codes"].includes("bad-request"))throw new Error(`Recaptcha: Server has invalid config: ${i["error-codes"].join(", ")}`);return i["error-codes"].includes("missing-input-response")||i["error-codes"].includes("invalid-input-response")?t(400,"Invalid token"):i["error-codes"].includes("timeout-or-duplicate")?t(400,"Token has expired or has already been used"):t(400,"Unknown error")}r(`${i.score}`)}catch(e){return o(e)}}};
