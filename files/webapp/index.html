<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoi</title>
</head>

<body>
    <iframe src="|url|$org" id="iframe1"></iframe>
    <iframe src="about:blank" id="iframe2" style="display: none"></iframe>
</body>

<style>
    iframe {
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        border: none;
        transition: left 0.5s ease 0s;
    }

    .coverDiv {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0);
    }
</style>

<script defer>
    let iframe = document.querySelector('iframe#iframe1');
    let oldLoc = iframe.src;

    function wait(ms) {
        return new Promise(res => {
            setTimeout(res, ms)
        })
    }

    function iframeURLChange(iframe) {
        var unloadHandler = function () {
            let body = iframe.contentWindow.document.body.innerHTML;
            let head = iframe.contentWindow.document.head.innerHTML;
            setTimeout(async () => {
                let loc = iframe.contentWindow.location.href;
                if (!loc.endsWith('$org'))
                    loc += '$org'

                if (oldLoc == loc) {
                    console.log('Unneeded page transition');
                    return
                }

                window.history.pushState(loc.split('$org')[0], loc.split('$org')[0], loc.split('$org')[0]);

                let coverDiv = document.createElement('div')
                coverDiv.classList.add('coverDiv')
                document.body.appendChild(coverDiv)

                await wait(100)

                let oldIframe = document.getElementById('iframe2')

                oldIframe.contentWindow.document.body.innerHTML =
                    body
                oldIframe.contentWindow.document.head.innerHTML =
                    head

                oldIframe.style.zIndex = 100
                // oldIframe.style.backgroundColor = 'white'
                oldIframe.style.display = null

                await wait(400)

                iframe.style.display = 'none';
                oldLoc = loc
                console.log(`Switching to ${loc}`)

                let newIframe = document.createElement('iframe')
                newIframe.style.left = '110vw'
                newIframe.src = loc;
                document.body.appendChild(newIframe)

                await wait(100)

                newIframe.style.left = 0;
                oldIframe.style.left = '-110vw'
                iframe.contentWindow.location.replace(loc)

                await wait(600)

                iframe.style.transition = 'none';
                oldIframe.style.display = 'none'
                oldIframe.contentWindow.location.replace('about:blank')
                oldIframe.style.left = null
                oldIframe.style.zIndex = null

                // await wait(100)

                iframe.style.display = null;

                await wait(100)

                newIframe.remove()

                await wait(500)

                coverDiv.remove()
            }, 0);
        };

        function attachUnload() {
            // Remove the unloadHandler in case it was already attached.
            // Otherwise, the change will be dispatched twice.
            iframe.contentWindow.removeEventListener("unload", unloadHandler);
            iframe.contentWindow.addEventListener("unload", unloadHandler);
        }

        iframe.addEventListener("load", attachUnload);
        attachUnload();
    }

    iframeURLChange(iframe);
</script>

</html>