<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoi</title>
</head>

<body>
    <iframe src="|url|$org"></iframe>
</body>

<style>
    iframe {
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        border: none;
        transition: left 0.5s ease 0s;
    }
</style>

<script defer>
    let iframe = document.querySelector('iframe');
    let oldLoc = iframe.src;

    function wait(ms) {
        return new Promise(res => {
            setTimeout(res, ms)
        })
    }

    function iframeURLChange(iframe) {
        var unloadHandler = function () {
            setTimeout(async () => {
                let loc = iframe.contentWindow.location.href;
                if (!loc.endsWith('$org'))
                    loc += '$org'

                if (oldLoc == loc) {
                    console.log('Unneeded page transition');
                    return
                }

                // window.frames[0].stop();
                iframe.contentWindow.location.replace(oldLoc)

                await wait(500)

                oldLoc = loc
                console.log(`Switching to ${loc}`)

                let newIframe = document.createElement('iframe')
                newIframe.style.left = '110vw'
                newIframe.src = loc;
                document.body.appendChild(newIframe)

                await wait(100)

                newIframe.style.left = 0;
                iframe.style.left = '-110vw'

                await wait(600)

                iframe.contentWindow.location.replace(loc)
                iframe.style.transition = 'none';

                await wait(100)

                iframe.style.left = null;
                newIframe.remove()

                await wait(100)

                iframe.style.transition = null
            }, 0);
        };

        function attachUnload() {
            // Remove the unloadHandler in case it was already attached.
            // Otherwise, the change will be dispatched twice.
            iframe.contentWindow.removeEventListener("unload", unloadHandler);
            iframe.contentWindow.addEventListener("unload", unloadHandler);
        }

        iframe.addEventListener("load", attachUnload);
        attachUnload();
    }

    iframeURLChange(iframe);
</script>

</html>