<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading</title>
</head>

<body>
    <iframe src="|url|$org" id="iframe1"></iframe>
    <iframe src="about:blank" id="iframe2" style="display: none"></iframe>
</body>

<style>
    iframe {
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        border: none;
        transition: left 0.5s ease 0s;
    }

    .coverDiv {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0);
    }

    #iframe2 {
        background-color: white;
        z-index: 100;
    }
</style>

<script defer>
    let isFirstLoad = true;
    let iframe = document.querySelector('iframe#iframe1');
    let oldLoc = iframe.src;

    let oldIframe = document.getElementById('iframe2')
    oldIframe.contentWindow.document.body.innerHTML =
        iframe.contentWindow.document.body.innerHTML
    oldIframe.contentWindow.document.head.innerHTML =
        iframe.contentWindow.document.head.innerHTML

    function changeTitle() {
        document.title = iframe.contentDocument.title;
    }

    ; (async () => {
        await wait(50)

        if (!isFirstLoad)
            return;
        isFirstLoad = true;

        changeTitle()
        oldIframe.contentWindow.document.body.innerHTML =
            iframe.contentWindow.document.body.innerHTML
        oldIframe.contentWindow.document.head.innerHTML =
            iframe.contentWindow.document.head.innerHTML
    })()

    function wait(ms) {
        return new Promise(res => {
            setTimeout(res, ms)
        })
    }

    function iframeURLChange(iframe) {
        var unloadHandler = function () {
            let body = iframe.contentWindow.document.body.innerHTML;
            let head = iframe.contentWindow.document.head.innerHTML;

            let oldDisplay = oldIframe.style.display;
            oldIframe.style.display = null

            setTimeout(async () => {
                let loc = iframe.contentWindow.location.href;
                if (!loc.endsWith('$org'))
                    loc += '$org'

                if (oldLoc == loc) {
                    oldIframe.style.display = oldDisplay
                    return
                }

                if (oldIframe.contentWindow.document.body.innerHTML != body)
                    oldIframe.contentWindow.document.body.innerHTML =
                        body
                if (oldIframe.contentWindow.document.head.innerHTML != head)
                    oldIframe.contentWindow.document.head.innerHTML =
                        head

                oldIframe.style.display = null

                let coverDiv = document.createElement('div')
                coverDiv.classList.add('coverDiv')
                document.body.appendChild(coverDiv)

                // await wait(400)
                // await wait(400)

                iframe.style.display = 'none';
                oldLoc = loc
                console.log(`Switching to ${loc}`)

                let newIframe = document.createElement('iframe')
                newIframe.style.left = '100vw'
                newIframe.src = loc;
                document.body.appendChild(newIframe)

                // await wait(100)
                await wait(100)

                newIframe.style.left = 0;
                oldIframe.style.left = '-100vw'
                iframe.contentWindow.location.replace(loc)

                await wait(250)

                changeTitle()
                if (window.location != loc.split('$org')[0])
                    window.history.pushState(loc.split('$org')[0], loc.split('$org')[0], loc.split('$org')[0]);

                await wait(350)

                iframe.style.transition = 'none';
                oldIframe.style.display = 'none'
                oldIframe.contentWindow.location.replace('about:blank')
                oldIframe.style.left = null
                oldIframe.style.zIndex = null

                // await wait(100)

                iframe.style.display = null;

                await wait(100)

                newIframe.remove()

                await wait(100)

                oldIframe.contentWindow.document.body.innerHTML =
                    iframe.contentWindow.document.body.innerHTML
                oldIframe.contentWindow.document.head.innerHTML =
                    iframe.contentWindow.document.head.innerHTML
                coverDiv.remove()
            }, 0);
        };

        function attachUnload() {
            // Remove the unloadHandler in case it was already attached.
            // Otherwise, the change will be dispatched twice.
            iframe.contentWindow.removeEventListener("unload", unloadHandler);
            iframe.contentWindow.addEventListener("unload", unloadHandler);
        }

        iframe.addEventListener("load", attachUnload);
        attachUnload();
    }

    iframeURLChange(iframe);

    window.onpopstate = function (e) {
        console.log(e.state)
        iframe.contentWindow.location.replace(e.state)
    };
</script>

</html>