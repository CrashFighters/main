import{publicRecaptchaV3Key,publicRecaptchaV2Key}from"/common/apiKeys.js";import{doesDocumentIncludeScript}from"/common/doesDocumentIncludeScript.js";async function getScoreFromV3Token(t){const a=await fetch(`/api/recaptchaV3?token=${t}`);return parseFloat(await a.text())}async function checkSuccessFromV2Token(t){try{const a=await fetch(`/api/recaptchaV2?token=${t}`);return await a.json()}catch(t){return console.error(t),!1}}function waitReady(){return new Promise((t=>{grecaptcha.ready(t)}))}export async function getScore(t="SDK_execute"){await waitReady();const a=await grecaptcha.execute(publicRecaptchaV3Key,{action:t});return await getScoreFromV3Token(a)}function renderV2Button(t){const a=[],e={state:"ready",onStateChange:t=>{a.push(t)}},c=t=>{e.state=t;for(const t of a)t(e)};return grecaptcha.render(t,{sitekey:publicRecaptchaV2Key,callback:async t=>{await checkSuccessFromV2Token(t)?c("success"):c("error")},"error-callback":()=>{c("error")},"expired-callback":()=>{c("expired")}}),e}export async function createButton(t){if(!t)throw new Error("No element provided to createButton");await waitReady();return renderV2Button(t)}const style=document.createElement("style");function googleCaptchaV3Callback(t){return async function(a){const e=document.getElementById(t);e.dataset.recaptcha_loading_class&&e.classList.add(e.dataset.recaptcha_loading_class);const c=await getScoreFromV3Token(a);window[e.dataset.recaptcha_callback]?.(c),e.dataset.recaptcha_loading_class&&e.classList.remove(e.dataset.recaptcha_loading_class)}}style.innerHTML="\n    .grecaptcha-badge { visibility: hidden; }\n",document.head.appendChild(style);const invisRecaptchaButtons=[...document.getElementsByClassName("invisRecaptchaButton")];for(const t of invisRecaptchaButtons){if(!t.id){console.error("captchaButton must have an id attribute",t);continue}const a=document.createElement("button");for(const e of Object.keys(t.dataset))a.dataset[e]=t.dataset[e];a.innerText=t.innerText,a.id=t.id,a.dataset.recaptcha_callback=t.dataset.recaptcha_callback,a.dataset.recaptcha_loading_class=t.dataset.recaptcha_loading_class,a.dataset.action=t.dataset.recaptcha_action??"SDK_invisButton",a.dataset.callback=`googleCaptchaV3Callback-${t.id}`,window[`googleCaptchaV3Callback-${t.id}`]=googleCaptchaV3Callback(t.id),a.className="g-recaptcha",a.dataset.sitekey=publicRecaptchaV3Key,t.replaceWith(a)}if(!doesDocumentIncludeScript("https://www.google.com/recaptcha/api.js")){const c=document.createElement("script");c.src=`https://www.google.com/recaptcha/api.js?render=${publicRecaptchaV3Key}`,document.head.appendChild(c)}
