import{initializeAppCheck,ReCaptchaV3Provider}from"https://www.gstatic.com/firebasejs/9.17.1/firebase-app-check.js";import{publicRecaptchaV3Key,publicRecaptchaV2Key}from"/common/apiKeys.js";async function getScoreFromV3Token(e){const t=await fetch(`/api/recaptchaV3?token=${e}`);return parseFloat(await t.text())}async function checkSuccessFromV2Token(e){try{const t=await fetch(`/api/recaptchaV2?token=${e}`);return await t.json()}catch(e){return console.error(e),!1}}function waitReady(){return new Promise((e=>{grecaptcha.ready(e)}))}window._recaptcha={initAppCheck:async function(e){const t=initializeAppCheck(e,{provider:new ReCaptchaV3Provider(publicRecaptchaV3Key),isTokenAutoRefreshEnabled:!0});window._captcha={firebase:{appCheck:t}}}};export async function getScore(e="SDK_execute"){await waitReady();const t=await grecaptcha.execute(publicRecaptchaV3Key,{action:e});return await getScoreFromV3Token(t)}function renderV2Button(e){let t=[],a={state:"ready",onStateChange:e=>{t.push(e)}};const c=e=>{a.state=e;for(const e of t)e(a)};return grecaptcha.render(e,{sitekey:publicRecaptchaV2Key,callback:async e=>{await checkSuccessFromV2Token(e)?c("success"):c("error")},"error-callback":()=>{c("error")},"expired-callback":()=>{c("expired")}}),a}export async function createButton(e){if(!e)throw new Error("No element provided to createButton");await waitReady();return renderV2Button(e)}const style=document.createElement("style");function googleCaptchaV3Callback(e){return async function(t){const a=document.getElementById(e),c=await getScoreFromV3Token(t);window[a.dataset.recaptcha_callback]?.(c)}}style.innerHTML="\n    .grecaptcha-badge { visibility: hidden; }\n",document.head.appendChild(style);const invisRecaptchaButtons=[...document.getElementsByClassName("invisRecaptchaButton")];for(const e of invisRecaptchaButtons){if(!e.id){console.error("captchaButton must have an id attribute",e);continue}const t=document.createElement("button");t.innerText=e.innerText,t.id=e.id,t.dataset.recaptcha_callback=e.dataset.recaptcha_callback,t.dataset.action=e.dataset.recaptcha_action??"SDK_invisButton",t.dataset.callback=`googleCaptchaV3Callback-${e.id}`,window[`googleCaptchaV3Callback-${e.id}`]=googleCaptchaV3Callback(e.id),t.className="g-recaptcha",t.dataset.sitekey=publicRecaptchaV3Key,e.replaceWith(t)}if(!doesDocumentIncludeScript("https://www.google.com/recaptcha/api.js")){const a=document.createElement("script");a.src=`https://www.google.com/recaptcha/api.js?render=${publicRecaptchaV3Key}`,document.head.appendChild(a)}function doesDocumentIncludeScript(e){const t=[...document.getElementsByTagName("script")];return Boolean(t.find((t=>t.src.endsWith(e))))}
