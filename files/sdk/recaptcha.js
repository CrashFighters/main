import{publicRecaptchaV3Key,publicRecaptchaV2Key}from"/common/apiKeys.js";async function getScoreFromV3Token(t){const e=await fetch(`/api/recaptchaV3?token=${t}`);return parseFloat(await e.text())}async function checkSuccessFromV2Token(t){try{const e=await fetch(`/api/recaptchaV2?token=${t}`);return await e.json()}catch(t){return console.error(t),!1}}function waitReady(){return new Promise((t=>{grecaptcha.ready(t)}))}export async function getScore(t="SDK_execute"){await waitReady();const e=await grecaptcha.execute(publicRecaptchaV3Key,{action:t});return await getScoreFromV3Token(e)}function renderV2Button(t){const e=[],a={state:"ready",onStateChange:t=>{e.push(t)}},c=t=>{a.state=t;for(const t of e)t(a)};return grecaptcha.render(t,{sitekey:publicRecaptchaV2Key,callback:async t=>{await checkSuccessFromV2Token(t)?c("success"):c("error")},"error-callback":()=>{c("error")},"expired-callback":()=>{c("expired")}}),a}export async function createButton(t){if(!t)throw new Error("No element provided to createButton");await waitReady();return renderV2Button(t)}const style=document.createElement("style");function googleCaptchaV3Callback(t){return async function(e){const a=document.getElementById(t);a.dataset.recaptcha_loading_class&&a.classList.add(a.dataset.recaptcha_loading_class);const c=await getScoreFromV3Token(e);window[a.dataset.recaptcha_callback]?.(c),a.dataset.recaptcha_loading_class&&a.classList.remove(a.dataset.recaptcha_loading_class)}}style.innerHTML="\n    .grecaptcha-badge { visibility: hidden; }\n",document.head.appendChild(style);const invisRecaptchaButtons=[...document.getElementsByClassName("invisRecaptchaButton")];for(const t of invisRecaptchaButtons){if(!t.id){console.error("captchaButton must have an id attribute",t);continue}const e=document.createElement("button");e.innerText=t.innerText,e.id=t.id,e.dataset.recaptcha_callback=t.dataset.recaptcha_callback,e.dataset.recaptcha_loading_class=t.dataset.recaptcha_loading_class,e.dataset.action=t.dataset.recaptcha_action??"SDK_invisButton",e.dataset.callback=`googleCaptchaV3Callback-${t.id}`,window[`googleCaptchaV3Callback-${t.id}`]=googleCaptchaV3Callback(t.id),e.className="g-recaptcha",e.dataset.sitekey=publicRecaptchaV3Key,t.replaceWith(e)}if(!doesDocumentIncludeScript("https://www.google.com/recaptcha/api.js")){const a=document.createElement("script");a.src=`https://www.google.com/recaptcha/api.js?render=${publicRecaptchaV3Key}`,document.head.appendChild(a)}function doesDocumentIncludeScript(t){const e=[...document.getElementsByTagName("script")];return Boolean(e.find((e=>e.src.endsWith(t))))}
